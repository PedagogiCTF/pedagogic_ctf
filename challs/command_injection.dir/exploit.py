#!/usr/bin/python3

import os
import random
import subprocess
import sys

from string import ascii_letters, digits


def run_cmd(correction_file, args):

    args.insert(0, correction_file)

    if correction_file.endswith('.py'):
        args.insert(0, 'python3')
    elif correction_file.endswith('.pl'):
        args.insert(0, 'perl')
    elif correction_file.endswith('.go'):
        args.insert(0, 'run')
        args.insert(0, 'go')

    child = subprocess.Popen(args, stdout=subprocess.PIPE)
    streamdata = child.communicate()[0]
    ret = child.returncode
    return streamdata.decode(), ret


# return false if the code is not exploitable anymore
def exploit(correction_file, secret):

    rand = ''.join(random.SystemRandom().choice(ascii_letters + digits) for _ in range(32))
    file_path = "/tmp/cmd_inject_{}_{}".format(rand, secret)
    _, _ = run_cmd(correction_file, ["www.ovh.com|touch " + file_path])
    if os.path.isfile(file_path):
        print("A character which is used to separate bash command is still usable and effective.")
        os.remove(file_path)
        return True
    return False


def main():

    correction_file = sys.argv[1]
    secret = sys.argv[2]
    return_code = 3 if exploit(correction_file, secret) else 0
    sys.exit(return_code)


if __name__ == "__main__":
    main()
