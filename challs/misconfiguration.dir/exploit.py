#!/usr/bin/python3

import subprocess
import sys


def run_cmd(correction_file, args):
    args.insert(0, correction_file)

    if correction_file.endswith('.py'):
        args.insert(0, 'python3')
    elif correction_file.endswith('.pl'):
        args.insert(0, 'perl')
    elif correction_file.endswith('.go'):
        args.insert(0, 'run')
        args.insert(0, 'go')

    child = subprocess.Popen(args, stdout=subprocess.PIPE)
    streamdata = child.communicate()[0]
    ret = child.returncode
    return streamdata.decode(), ret


def exploit(correction_file, secret):
    """
        Check if the corrected source code is still vulnerable
    """
    content, code = run_cmd(correction_file, ['', 'rien', '/get-secret'])
    if content.find('e9bc7d25d16348f9c5f6b9251c270c0da39aff8b') > 0:
        print('token seems to leak from your app')
        return True

    content, code = run_cmd(correction_file, ['rien', '', '/get-secret'])
    if content.find('debug-e9bc7d25d163') > 0:
        print('username seems to leak from your app')
        return True

    return False


def main():
    secret = sys.argv[1]
    correction_file = sys.argv[2]
    return_code = 3 if exploit(correction_file, secret) else 0
    sys.exit(return_code)


if __name__ == "__main__":
    main()
